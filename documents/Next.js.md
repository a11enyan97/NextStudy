# Next.js

> Next.js是一个基于React的一个服务端渲染框架。
>
> 通过 Next.js 框架开发的 React 应用无需配置就可以如服务端渲染 SSR、编译时渲染 SSG，Typescript 语言支持，自动打包，路由愈加载等功能。

------



## 项目创建

> Next.js 提供了开箱即用的 `create-next-app`脚手架，内置支持 TypeScript、ESLint 等功能，零配置即可实现自动编译和打包。

### 自动创建项目

#### 1.环境要求

​	本次学习开始于2024年1月4日，使用的Next.js版本为最新的14版本，需要最低为Node.js 18.17版本。

#### 2.创建项目

​	使用Next.js内置脚手架自动创建项目：

```javascript
npx create-next-app@latest
```

<font color='skyblue'>因为我们是使用 `npx`创建的项目，这种方式下避免了全局安装 `create-next-app`，所以我们本地全局并无 `next` 命令。如果你要执行 `next` 命令，可以在 `next`前加一个 `npx`</font>

#### 3.运行项目

​	查看项目根目录中的`package.json`文件的代码：

```javascript
// package.json
  "scripts": {
    "dev": "next dev",     //开发
    "build": "next build", //构建
    "start": "next start", //运行
    "lint": "next lint"	   //代码检查
  },

```

开发的时候使用 `npm run dev`；部署的时候先使用 `npm run build`构建生产代码，再执行 `npm run start`运行生产项目。运行 `npm run lint`则会执行 ESLint 语法检查。

### 手动创建项目

> [手动创建项目学习链接](https://juejin.cn/book/7307859898316881957/section/7307280276332544027#heading-6)

### Next.js CLI

> 当我们运行 `npm run dev` 的时候，其实执行的是 `next dev`。
>
> 而`next` 命令就是来自于 Next.js CLI。Next.js CLI 可以帮助你启动、构建和导出项目。

#### 1.next build

- `next build --profile`
- `next build --debug`

#### 2.next dev

#### 3.next start

#### 4.next lint

#### 5.next info

------



## APP Router

> Next.js 目前有两套路由解决方案，之前的方案称之为“Pages Router”，目前的方案称之为“App Router”，两套方案是兼容的，都可以在 Next.js 中使用。

> `Next.js版本号>13.4`默认在使用脚手架创建新项目时，对项目的文件目录配置为“App Router”方案。
>
> Next.js 从 v13 起就使用了新的路由模式 —— App Router。之前的路由模式我们称之为“Pages Router”，为保持渐进式更新，依然存在。从 v13.4 起，App Router 正式进入稳定化阶段，App Router 功能更强、性能更好、代码组织更灵活，<font color='red'>以后就让我们使用新的路由模式吧！</font>

```javascript
src/
└── app
    ├── page.js 
    ├── layout.js
    ├── template.js
    ├── loading.js
    ├── error.js
    └── not-found.js
    ├── about
    │   └── page.js
    └── more
        └── page.js

```

<font color='red'>`app` </font>下多了很多文件。这些文件的名字并不是乱起的，而是 Next.js 约定的一些特殊文件。从这些文件的名称中你也可以了解文件实现的功能，比如布局（layout.js）、模板（template.js）、加载状态（loading.js）、错误处理（error.js）、404（not-found.js）等。

### 使用App Router

#### 1.定义路由

Next.js项目中，**文件夹被用于定义路由**。也就是说<font color='red'>不需要额外引入路由组件或者配置路由文件</font>，每个文件夹就标识路由的一级路径，例如：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c35a76b0027c4e9fb5bc0d5807f479f4~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp#?w=1600&h=594&s=339521&e=png&b=141414)

#### 2.定义页面

> 展示页面的源码文件

Next.js约定<font color='red'>`page.js`</font>为具体页面的代码文件命名，（ps：通俗理解就是index.js

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40820ff4957244899288d7534bd4c525~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp#?w=1600&h=687&s=314397&e=png&b=171717)

#### 3.定义布局

> 布局是指多个页面共享的 UI。

设文件目录构成如下图所示：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a7872449f6e4c6fb1808f518db7783f~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp#?w=1600&h=606&s=295670&e=png&b=151515)

**同一文件夹下如果有 layout.js 和 page.js，page 会作为 children 参数传入 layout。换句话说，layout 会包裹同层级的 page。**

```react
// app/dashboard/layout.js
export default function DashboardLayout({
  children,
}) {
  return (
    <section>
      <nav>nav</nav>
      {children}
    </section>
  )
}

// app/dashboard/page.js
export default function Page() {
  return <h1>Hello, Dashboard!</h1>
}
```

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43c72c2017354f1e9c292c2bbb9aaa40~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp#?w=710&h=268&s=27102&e=png&b=000000)

**布局是支持嵌套的，`layout.js`和`page.js`都支持**

- `layout.js`嵌套子级的`page.js`

```react
// app/dashboard/layout.js
export default function DashboardLayout({
  children,
}) {
  return (
    <section>
      <nav>nav</nav>
      {children}
    </section>
  )
}

// app/dashboard/settings/page.js
export default function Page() {
  return <h1>Hello, Settings!</h1>
}
```

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53456de28a684fe3902eb2ce5f4c07a0~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp#?w=808&h=266&s=29753&e=png&b=000000)

如上图所示，由于`layout`布局具有嵌套特性，因此在`app/dashboard/settings/pages`中会使用`app/dashboard/layout.js`和`app/layout.js`两个**父layout**

##### 根布局

> 布局支持嵌套，最顶层的布局我们称之为根布局（Root Layout），也就是 `app/layout.js`，它会应用于所有的路由。

- `app`目录必须包含根布局，也就是 `app/layout.js` 这个文件是<font color='red'>必需的</font>。

- 根布局文件`app/layout.js`<font color='red'>必须包含</font>`html` 和 `body`标签，其他布局<font color='red'>不能包含</font>这些标签。

  ```js
  // app/layout.js
  import './globals.css'
  import { Inter } from 'next/font/google'
  
  const inter = Inter({ subsets: ['latin'] })
  
  export const metadata = {
    title: 'Create Next App',
    description: 'Generated by create next app',
  }
  
  export default function RootLayout({ children }) {
    return (
      <html lang="en">
        <body className={inter.className}>{children}</body>
      </html>
    )
  }
  ```

  

- 可以使用[路由组](https://juejin.cn/book/7307859898316881957/section/7308693561648611379#heading-5)创建多个根布局。

- 默认根布局是[服务端组件](https://juejin.cn/book/7307859898316881957/section/7309076661532622885)，且不能设置为客户端组件。

#### 4.定义模板

> 模板与布局类似，它会传入每个子布局和页面，但不会像布局那样维持状态。
>
> 模板在进行路由切换时，会为每一个children创建一个实例。这就意味着**当用户在共享一个模板的路由间跳转时，会重新挂在组件实例，重新创建DOM元素，从而不保留状态。**

`template.js`用法跟布局一模一样。它们最大的区别就是状态的保持。如果同一目录下既有 `template.js` 也有 `layout.js`，最后的输出效果如下：也就是说 `layout` 会包裹 `template`，`template` 又会包裹 `page`。

```tsx
<Layout>
  {/* 模板需要给一个唯一的 key */}
  <Template key={routeParam}>{children}</Template>
</Layout>
```

模板比布局更适合的场景：

1. 依赖于 useEffect 和 useState 的功能，比如记录页面访问数（维持状态就不会在路由切换时记录访问数了）、用户反馈表单（每次重新填写）等
2. 更改框架的默认行为，举个例子，布局内的 Suspense 只会在布局加载的时候展示一次 fallback UI，当切换页面的时候不会展示。但是使用模板，fallback 会在每次路由切换的时候展示

#### 5.模板`（template）`VS布局`（layout）`

[对比示例](https://juejin.cn/book/7307859898316881957/section/7308681814742417434#heading-10 )

#### 6.定义加载界面

> `loading.js`用于展示加载界面，该功能实现借助了React的`Suspense`API

```tsx
// 在 ProfilePage 组件处于加载阶段时显示 Spinner
<Suspense fallback={<Spinner />}>
  <ProfilePage />
</Suspense>
```

`ProfilePage`组件会抛出一个数据加载的`Promise`，`Suspense`会捕获这个`Promise`,成功状态则会更新替换fallbackUI为`ProfilePage`组件

#### 7.定义错误处理

因为 `Layout` 和 `Template` 在 `ErrorBoundary` 外面，这说明错误边界不能捕获同级的 `layout.js` 或者 `template.js` 中的错误。如果你想捕获特定布局或者模板中的错误，那就需要在父级的 `error.js` 里进行捕获。

如果已经到了顶层，就比如根布局中的错误如何捕获呢？为了解决这个问题，Next.js 提供了 `global-error.js`文件，使用它时，需要将其放在 `app` 目录下。

##### 层级问题

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eeb2e4b635f0473785c0ba9d79df01b6~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp#?w=1600&h=641&s=327102&e=png&b=1c1c1c)

#### 8.定义404界面
